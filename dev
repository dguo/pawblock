#!/usr/bin/env python

import argparse
import os
from subprocess import call
import sys
import zipfile

parser = argparse.ArgumentParser(prog='./dev')
subparsers = parser.add_subparsers(metavar='<command>', title='commands')

DOCKER_RUN = ['docker', 'run', '-it', '--rm', '-v',
              os.getcwd() + ':/src:cached', '-w=/src', 'node:8.2.1-alpine']

def sh(args, remaining):
    call(DOCKER_RUN + ['sh'])
parser_sh = subparsers.add_parser('sh', help='Bring up a shell')
parser_sh.set_defaults(func=sh)

def npm(args, remaining):
    call(DOCKER_RUN + ['npm'] + remaining or [])
parser_npm = subparsers.add_parser('npm', help='Run a npm command')
parser_npm.set_defaults(func=npm)

def format(args, remaining):
    rc = call(DOCKER_RUN + ['npx', 'prettier', '--single-quote',
                            '--no-bracket-spacing', '--write', '**/*.js'])
    exit(rc)
parser_format = subparsers.add_parser('format',
    help='Format the code with Prettier')
parser_format.set_defaults(func=format)

def lint(args, remaining):
    rc = call(DOCKER_RUN + ['npx', 'eslint', '**/*.js'])
    exit(rc)
parser_lint = subparsers.add_parser('lint', help='Lint the code with ESLint')
parser_lint.set_defaults(func=lint)

def release(args, remaining):
    if raw_input('Did you update the manifest version [y/n]? ').lower() != 'y':
        exit(1)
    if raw_input('Did you update the changelog [y/n]? ').lower() != 'y':
        exit(1)
    with zipfile.ZipFile('pawblock.zip', 'w',
                         zipfile.ZIP_DEFLATED) as handle:
        os.chdir('extension')
        for root, dirs, files in os.walk('.'):
            for file in files:
                if file != '.DS_Store':
                    handle.write(os.path.join(root, file))
    print('Upload the new zip file to the Chrome Web Store:')
    print('https://chrome.google.com/webstore/developer/edit/jngmmiaolbliepfphdnelgfcclpnkoja')
    print('And to Mozilla Add-ons:')
    print('https://addons.mozilla.org/en-US/developers/addon/pawblock/edit')
parser_release = subparsers.add_parser('release', help='Help release an update')
parser_release.set_defaults(func=release)

def test(args, remaining):
    rc = call(DOCKER_RUN + ['npx', 'jest'])
    exit(rc)
parser_test = subparsers.add_parser('test', help='test the code')
parser_test.set_defaults(func=test)


if len(sys.argv) > 1:
    args, remaining = parser.parse_known_args()
    args.func(args, remaining)
else:
    parser.print_help()
